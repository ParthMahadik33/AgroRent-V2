<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Machinery Availability Heatmap - AgroRent</title>
    <style>
        /* Modern Reset & Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        /* Navbar / Header */
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        header h1 {
            font-size: 1.5rem;
            font-weight: 500;
        }

        .back-link {
            color: #ecf0f1;
            text-decoration: none;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: color 0.2s;
        }

        .back-link:hover {
            color: #3498db;
        }

        /* Map Container */
        #map {
            flex: 1;
            width: 100%;
            height: 100%;
            background-color: #e5e3df;
            /* Google Maps Loading Gray */
        }

        /* Loading / Status Overlay */
        #status-panel {
            position: absolute;
            top: 80px;
            left: 20px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            z-index: 5;
            min-width: 250px;
            font-size: 0.9rem;
            display: none;
            /* Hidden by default or until needed */
        }

        #status-panel h3 {
            margin-bottom: 10px;
            font-size: 1rem;
            color: #2c3e50;
        }

        #progress-bar {
            width: 100%;
            height: 6px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        #progress-fill {
            height: 100%;
            background: #27ae60;
            width: 0%;
            transition: width 0.3s ease;
        }

        .status-text {
            color: #7f8c8d;
            font-size: 0.85rem;
        }

        /* Floating Legend */
        #legend {
            background: white;
            padding: 10px;
            margin: 10px;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
            font-family: Arial, sans-serif;
            font-size: 12px;
            line-height: 1.5;
            display: none;
        }
    </style>
</head>

<body>

    <header>
        <h1>Machinery Availability Heatmap</h1>
        <a href="/" class="back-link">&larr; Back to Home</a>
    </header>

    <div id="status-panel">
        <h3>Loading Data</h3>
        <div id="progress-bar">
            <div id="progress-fill"></div>
        </div>
        <div class="status-text" id="status-text">Connecting to backend...</div>
    </div>

    <div id="map"></div>

    <script>
        // GLOBAL VARIABLES
        let map;
        let heatmap;
        let geocoder;
        let locations = [];
        let heatmapData = [];
        let processedCount = 0;
        let totalLocations = 0;

        // --- AUTH & CONFIG ---
        // IMPORTANT: REPLACE 'YOUR_GOOGLE_MAPS_API_KEY' WITH YOUR ACTUAL KEY.
        // The user requested the key be written directly here.
        // Since no key was provided in the context, a placeholder is used.
        const API_KEY = 'AIzaSyB57wCwFYE87gI3d_bImoog5D3qnkoU7Ic';

        // --- MAP INITIALIZATION ---
        function initMap() {
            // Center roughly on India
            const indiaCenter = { lat: 20.5937, lng: 78.9629 };

            map = new google.maps.Map(document.getElementById("map"), {
                zoom: 5,
                center: indiaCenter,
                mapTypeId: 'roadmap',
                mapTypeControl: false,
                streetViewControl: false,
            });

            heatmap = new google.maps.visualization.HeatmapLayer({
                data: [],
                map: map,
                radius: 30,
                opacity: 0.8
            });

            geocoder = new google.maps.Geocoder();

            // Start Data Fetch
            fetchData();
        }

        // --- DATA FETCHING ---
        async function fetchData() {
            const statusPanel = document.getElementById('status-panel');
            const statusText = document.getElementById('status-text');
            statusPanel.style.display = 'block';
            statusText.innerText = 'Fetching locations from database...';

            try {
                const response = await fetch('/api/heatmap_locations');
                if (!response.ok) throw new Error('Network response was not ok');

                const data = await response.json();
                locations = data;
                totalLocations = locations.length;

                if (totalLocations === 0) {
                    statusText.innerText = 'No machinery listings found.';
                    setTimeout(() => statusPanel.style.display = 'none', 3000);
                    return;
                }

                statusText.innerText = `Found ${totalLocations} locations. Starting geocoding...`;

                // Start Geocoding Process
                processLocations();

            } catch (error) {
                console.error('Error fetching data:', error);
                statusText.innerText = 'Error loading data. Check console.';
                statusText.style.color = '#c0392b';
            }
        }

        // --- GEOCODING LOGIC ---
        // Google Geocoding API has rate limits. We process sequentially with delays.
        // If we hit OVER_QUERY_LIMIT, we back off.

        async function processLocations() {
            const statusText = document.getElementById('status-text');
            const progressFill = document.getElementById('progress-fill');

            for (let i = 0; i < locations.length; i++) {
                const loc = locations[i];
                const address = loc.address;
                const weight = loc.weight;

                try {
                    const result = await geocodeAddress(address);
                    if (result) {
                        // Add weighted data point
                        // We add points multiple times or use the 'weight' property if using WeightedLocation
                        // For simplicity in visualization, HeatmapLayer accepts {location, weight} objects.
                        const dataPoint = {
                            location: result,
                            weight: weight
                        };

                        // Push to MVC array to update map live (optional, or push to array and set at end)
                        // Live update is cooler for users to see
                        heatmapData.push(dataPoint);
                        heatmap.setData(heatmapData);
                    }
                } catch (e) {
                    console.warn(`Skipping ${address}:`, e);
                }

                // Update UI
                processedCount++;
                const percent = (processedCount / totalLocations) * 100;
                progressFill.style.width = `${percent}%`;
                statusText.innerText = `Geocoding: ${processedCount}/${totalLocations}`;

                // Artificial delay to respect rate limits (e.g., 10 requests per sec standard free tier, but safe side 200ms)
                await new Promise(r => setTimeout(r, 300));
            }

            statusText.innerText = 'Visualization Complete!';
            setTimeout(() => {
                document.getElementById('status-panel').style.opacity = '0';
                setTimeout(() => document.getElementById('status-panel').style.display = 'none', 500);
            }, 2000);
        }

        function geocodeAddress(address) {
            return new Promise((resolve, reject) => {
                geocoder.geocode({ 'address': address }, (results, status) => {
                    if (status === 'OK') {
                        resolve(results[0].geometry.location);
                    } else if (status === 'OVER_QUERY_LIMIT') {
                        // If limit hit, we could retry, but here we just fail specific item to keep moving
                        // In production, implement exponential backoff
                        console.warn('Rate limit hit for:', address);
                        reject('OVER_QUERY_LIMIT');
                    } else {
                        console.warn('Geocode failed for ' + address + ': ' + status);
                        reject(status);
                    }
                });
            });
        }

        // --- SCRIPT LOADING ---
        function loadGoogleMaps() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${API_KEY}&libraries=visualization&callback=initMap`;
            script.async = true;
            script.defer = true;
            script.onerror = function () {
                alert("Failed to load Google Maps API. Please check your API Key in heatmap.html.");
            };
            document.head.appendChild(script);
        }

        // Start loading when page is ready
        window.onload = loadGoogleMaps;

    </script>
</body>

</html>